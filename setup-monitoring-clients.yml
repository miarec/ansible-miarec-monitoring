---
# ------------------------------------------------
# Install Prometheus agent
# ------------------------------------------------
- name: Install Prometheus Agent.
  hosts:
    - prometheus-agent
  become: true
  pre_tasks:
    - name: Update apt cache [Debian].
      apt:
        update_cache: true
        cache_valid_time: 600
      when: ansible_os_family == 'Debian'
      changed_when: false

  roles:
    - role: miarec.prometheus

  tags: 'prometheus'

# ------------------------------------------------
# Install Montioring clients
# ------------------------------------------------
- name: Install Monitoring Clients.
  hosts:
    - all
  become: true
  pre_tasks:

# Set Hsot specific vars
    - include_vars:
        file: vars/recorder.yml
      when: "'recorder' in group_names"

    - include_vars:
        file: vars/screen.yml
      when: "'screen' in group_names"

    - include_vars:
        file: vars/livemon.yml
      when: "'livemon' in group_names"

    - include_vars:
        file: vars/db.yml
      when: "'db' in group_names"

    - include_vars:
        file: vars/redis.yml
      when: "'redis' in group_names"

    - include_vars:
        file: vars/livemon.yml
      when: "'livemon' in group_names"

    - include_vars:
        file: vars/web.yml
      when: "'web' in group_names"

    - include_vars:
        file: vars/celery.yml
      when: "'celery' in group_names"

    - include_vars:
        file: vars/celerybeat.yml
      when: "'celerybeat' in group_names"



    - set_fact:
        promtail_scrape_jobs: |
          {{ recorder_promtail_scrape_jobs +
              screen_promtail_scrape_jobs +
              livemon_promtail_scrape_jobs +
              db_promtail_scrape_jobs +
              redis_promtail_scrape_jobs +
              web_promtail_scrape_jobs +
              celery_promtail_scrape_jobs +
              celerybeat_promtail_scrape_jobs +
              }}

    - debug:
        var: promtail_scrape_jobs

    - name: Update apt cache [Debian].
      apt:
        update_cache: true
        cache_valid_time: 600
      when: ansible_os_family == 'Debian'
      changed_when: false

  roles:
    - role: miarec.promtail
    - role: cloudalchemy.node_exporter
    - role: miarec.process_exporter

  tags: 'clients'